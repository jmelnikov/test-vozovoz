# Vozovoz API

Система регистрации и учёта пилотов корпорации Deep Space Conquerors.

### О проекте

На основной странице форма, дублирующая функционал тформы на главной странице сайта [Vozovoz](https://vozovoz.ru/).
На странице `/terminals` поиск терминалов по городам.

### Кэширование

Так как запросы на сервер выполняются достаточно медленно, я реализовал кэширование их результатов.
Сейчас все запросы к серверу кэшируются на 1 час (3600 секунд).
Время кэширования можно задать для каждого сервиса отдельно, изменив константу `CACHE_TTL` в соответствующем классе.

Для кэширования используется **Redis**, ключами выступают конкатенированные параметры для поиска.
Если параметры для поиска достаточно большие, то в качестве ключа используется **MD5 хэш** от их сериализованного
представления.

### Запуск

Для работы с проектом необходимо установить [Docker](https://docs.docker.com/get-docker/)
и [Docker Compose](https://docs.docker.com/compose/install/).

Чтобы запустить проект на определённом порту, нужно в файле `docker-compose.yml` изменить порт в разделе `ports`:

```yaml
  nginx:
    ports:
      - "8088:80"
```

Для запуска проекта достаточно запустить команду `docker-compose up` в директории `docker`.
После установки пакетов `composer`, проект будет доступен на указанном выше порту.

### Использование

#### Получение городов

На ендпоинт `/api/cities` отправить `GET` запрос со следующими параметрами:

- `query` - строка с частью названия города
- `limit` - цифра, ограничивающая количество результатов
- `offset` - смещение в выдаче результатов

В ответ клиент получает список городов в следующем формате:

```json
{
  "success": true,
  "cities": [
    {
      "id": "e90f19de-0128-11e5-80c7-00155d903d03",
      "name": "Санкт-Петербург"
    }
  ]
}
```

#### Получение терминалов

На ендпоинт `/api/terminals` отправить `GET` запрос со следующими параметрами:

- `query` - строка с названием города или его `id`, полученном в предыдущем запросе
- `limit` - цифра, ограничивающая количество результатов
- `offset` - смещение в выдаче результатов

В ответ клиент получает список терминалов в указанном городе в следующем формате:

```json
{
  "success": true,
  "terminals": [
    {
      "id": "fc1d7417-c2aa-11ea-bbde-00155db5c401",
      "name": "1-ый Бадаевский проезд 11(прием груза)",
      "address": "Санкт-Петербург, 1-ый Бадаевский проезд, 11",
      "note": "+7-911-971-17-05(склад приема)",
      "coordinates": {
        "latitude": "59.8091",
        "longitude": "30.4062"
      },
      "conditions": {
        "width": {
          "min": 0,
          "max": 2.4
        },
        "length": {
          "min": 0,
          "max": 12.9
        },
        "height": {
          "min": 0,
          "max": 2.4
        }
      },
      "timetable": {
        "workday": {
          "from": "07:00",
          "to": "22:00",
          "isWorking": true
        },
        "saturday": {
          "from": "10:00",
          "to": "19:00",
          "isWorking": true
        },
        "sunday": {
          "from": "10:00",
          "to": "19:00",
          "isWorking": true
        }
      },
      "description": "макс. вес 1-го места 2500 кг при  габаритах  12,9м * 2,4м * 2,4м"
    }
  ]
}
```

#### Получение стоимости перевозки

На ендпоинт `/api/calc/form` отправить `GET` запрос со следующими параметрами:

- `deliveryFrom` - название города отправления или его `id`
- `terminalFrom` - `id` терминала отправления (опционально)
- `deliveryTo` - название города получения или его `id`
- `terminalTo` - `id` терминала получения (опционально)
- `radioFrom` - место погрузки отправления. Доступные варианты `terminal` и `address`
- `radioTo` - место доставки отправления. Доступные варианты `terminal` и `address`
- `volume` - объём отправления в кубических метрах
- `weight` - вес отправления в кубических метрах
- `quantity` - количество упаковочных мест в отправлении

В ответ клиент получит рассчитанную стоимость перевозки по выбранному направлению в следующем формате:

```json
{
  "success": true,
  "price": {
    "basePrice": 740,
    "price": 730,
    "service": [
      {
        "basePrice": 0,
        "name": "Платный въезд (отправитель)",
        "price": 0
      },
      {
        "basePrice": 651,
        "name": "Перевозка между городами",
        "price": 641
      },
      {
        "basePrice": 29,
        "name": "Страхование груза без объявленной стоимости",
        "price": 29
      },
      {
        "basePrice": 60,
        "name": "Складская обработка",
        "price": 60
      }
    ],
    "deliveryTime": {
      "from": 1,
      "to": 1
    }
  }
}
```

### Возможные ошибки

Если передать в качестве терминала отправки терминал, работающий только на приём, то вместо расчёта стоимости вернётся
ошибка следующего вида:

```json
{
  "success": false,
  "error": "ППВ работает только на выдачу"
}
```
